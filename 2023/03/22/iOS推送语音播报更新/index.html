<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>iOS推送播放语音播报更新 | 今是昨非的博客</title><meta name="author" content="今是昨非"><meta name="copyright" content="今是昨非"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="iOS推送播放语音播报更新接上篇如何让iOS推送播放语音，之前的结论是iOS如果需要送审商店只能播放本地的mp3文件，这里更新一下：">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS推送播放语音播报更新">
<meta property="og:url" content="http://morganwang.cn/2023/03/22/iOS%E6%8E%A8%E9%80%81%E8%AF%AD%E9%9F%B3%E6%92%AD%E6%8A%A5%E6%9B%B4%E6%96%B0/index.html">
<meta property="og:site_name" content="今是昨非的博客">
<meta property="og:description" content="iOS推送播放语音播报更新接上篇如何让iOS推送播放语音，之前的结论是iOS如果需要送审商店只能播放本地的mp3文件，这里更新一下：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://morganwang.cn/assets/img/avatar.jpeg">
<meta property="article:published_time" content="2023-03-22T08:18:00.000Z">
<meta property="article:modified_time" content="2024-01-22T11:04:42.000Z">
<meta property="article:author" content="今是昨非">
<meta property="article:tag" content="技术">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://morganwang.cn/assets/img/avatar.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "iOS推送播放语音播报更新",
  "url": "http://morganwang.cn/2023/03/22/iOS%E6%8E%A8%E9%80%81%E8%AF%AD%E9%9F%B3%E6%92%AD%E6%8A%A5%E6%9B%B4%E6%96%B0/",
  "image": "http://morganwang.cn/assets/img/avatar.jpeg",
  "datePublished": "2023-03-22T08:18:00.000Z",
  "dateModified": "2024-01-22T11:04:42.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "今是昨非",
      "url": "http://morganwang.cn"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://morganwang.cn/2023/03/22/iOS%E6%8E%A8%E9%80%81%E8%AF%AD%E9%9F%B3%E6%92%AD%E6%8A%A5%E6%9B%B4%E6%96%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'iOS推送播放语音播报更新',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/assets/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">188</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1477346611705-65d1883cee1e);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">今是昨非的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">iOS推送播放语音播报更新</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">iOS推送播放语音播报更新</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-03-22T08:18:00.000Z" title="发表于 2023-03-22 16:18:00">2023-03-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-22T11:04:42.000Z" title="更新于 2024-01-22 19:04:42">2024-01-22</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="iOS推送播放语音播报更新"><a href="#iOS推送播放语音播报更新" class="headerlink" title="iOS推送播放语音播报更新"></a>iOS推送播放语音播报更新</h2><p>接上篇<a href="https://morganwang.cn/2021/05/13/%E5%A6%82%E4%BD%95%E8%AE%A9iOS%E6%8E%A8%E9%80%81%E6%92%AD%E6%94%BE%E8%AF%AD%E9%9F%B3/">如何让iOS推送播放语音</a>，之前的结论是iOS如果需要送审商店只能播放本地的mp3文件，这里更新一下：</p>
<span id="more"></span>

<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p>语音的播放，最终调用的方法是<code>UNNotificationSound(named: xxx)</code>，而这个方法官方文档注释如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The sound file to be played for the notification. The sound must be in the Library/Sounds folder of the app&#x27;s data container or the Library/Sounds folder of an app group data container. If the file is not found in a container, the system will look in the app&#x27;s bundle.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">convenience</span> <span class="function"><span class="keyword">init</span>(<span class="params">named</span> <span class="params">name</span>: <span class="type">UNNotificationSoundName</span>)</span></span><br></pre></td></tr></table></figure>

<p>注释里说，语音文件会从这三个地方查找：</p>
<ol>
<li>APP 的<code>Library/Sounds</code>文件夹，</li>
<li>APP和 Extension共享Group的<code>Library/Sounds</code>文件夹</li>
<li>App bundle</li>
</ol>
<p>而之前文章里介绍的，就是属于第三种情况，直接放在<code>App bundle</code>中的情况。 这种情况的局限性在于，每次有新增或者变更，都需要变更同步到项目，然后APP发版用户更新后才能生效。</p>
<p>这种太麻烦了，有没有可能，不用更新版本，并且能直接增加新的语音种类，本篇介绍的就是这种。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>不更新版本，增加新的语音种类，就需要考虑，是否能在线下载？看上面的播放方法语音文件的查找目录，考虑是否可以通过在线下载语音文件到 APP 的<code>Library/Sounds</code>文件夹 或者 APP和 Extension共享Group的<code>Library/Sounds</code>文件夹下。</p>
<p>首先考虑第一种情况，如果想要下载到APP的<code>Library/Sounds</code>文件夹下，要怎么做呢？直接在推送时配置下载链接是否可行？</p>
<p>笔者尝试的是，在<code>Notification Service Extension</code>的target中，获取到配置的语音文件链接，然后下载，存储到<code>Library/Sounds</code>文件夹下，下载成功后，再去播放。</p>
<p>验证后发现不可行，因为此时的目录不是APP的<code>Library/Sounds</code>目录，而是推送Target的appex的<code>Library/Sounds</code>目录，而这个目录不在语音文件的查找范围内，所以这种不可行？那如何下载到APP 的<code>Library/Sounds</code>目录下呢？</p>
<h3 id="下载到-APP-的Library-Sounds"><a href="#下载到-APP-的Library-Sounds" class="headerlink" title="下载到 APP 的Library/Sounds"></a>下载到 APP 的<code>Library/Sounds</code></h3><p>笔者想到有两种可能方案：</p>
<ol>
<li>推送时配置下载链接，在APP处理推送方法的地方，进行下载</li>
<li>单独接口配置下载链接，APP打开时调用，提前下载</li>
</ol>
<p>首先方案一，APP 处理推送方法是在<code>Notification Service Extension</code>的<code>contentHandler</code>之后，而语音播报是在<code>contentHandler</code>时，即，下载在播报之后，这种情况下，第一次的语音是播报不出来的；而且 APP 不打开的情况下，是否允许下载，是否能下载成功都未知，所以不可取。</p>
<p>再来看方案二，方案二的实现是一定没有问题的，通过单独的配置接口，下发语音下载链接，下载到 APP 的<code>Library/Sounds</code>文件夹下，然后推送时，只需要保证播放的名字和文件夹下名字一致即可。只不过，这个方案需要新增一个配置接口，而且需要提前下发配置链接，以保证用户提前下载成功，才能在真正推送时播放对应的文件。</p>
<p>Ps:<br>如果采用方案二，是可以连语音下载链接都可以省掉，只需要告诉 APP 要播放的内容就可以，APP 内部把要播放的内容转为通过TTS语音库转为语音文件，并存储到<code>Library/Sounds</code>下即可。</p>
<h3 id="APP和-Extension共享Group的Library-Sounds文件夹"><a href="#APP和-Extension共享Group的Library-Sounds文件夹" class="headerlink" title="APP和 Extension共享Group的Library/Sounds文件夹"></a>APP和 Extension共享Group的<code>Library/Sounds</code>文件夹</h3><p>如果不想新增配置接口，能不能直接在推送时下载呢？</p>
<p>答案是可以的，通过下载到APP和 Extension共享Group的<code>Library/Sounds</code>文件夹这种方案，可以实现推送时下载并播放。具体步骤如下：</p>
<ol>
<li>创建 APP 和 <code>Notification Service Extension</code>共享的 Group</li>
<li>在<code>didReceive(_ request: UNNotificationRequest, withContentHandler contentHandler: @escaping (UNNotificationContent) -&gt; Void)</code>方法中，获取下载链接，并下载</li>
<li>下载成功后，存储到Group的<code>Library/Sounds</code>文件夹下</li>
<li>存储成功后，播放</li>
</ol>
<p>通过这种方案，就可以实现在推送时，配置语音文件链接，从而下载并播放。这种方案需要考虑要下载文件的时间和大小，因为超过一定时间后，<code>Notification Service Extension</code>就会自动回调了；而且文件如果太大，即使下载成功也有可能播放失败。</p>
<p>Ps：这种方案也可以考虑直接推送要播放的内容，然后通过离线语音库合成音频文件，存储到Group的<code>Library/Sounds</code>下，然后播放，这里不做详细介绍，感兴趣可以自己实验。</p>
<p>再来考虑一个问题，假如项目里已经有了某些音频文件，要推送消息时，是否会根据项目中有没有决定加不加语音文件链接？当然不是，产品或者运营推送时是不会判断的，他们一定是无脑加；所以，项目中需要判断，判断按步骤判断项目Bundle 中有没有，再判断APP 的<code>Library/Sounds</code>下有没有，再判断共享Group的<code>Library/Sounds</code>中有没有已下载过，最后才是去下载。</p>
<p>具体代码大致如下：</p>
<ol>
<li>首先判断项目Bundle 中有没有音频文件，由于在Extension中获取不到主项目的 bundle，所以需要在打开 APP 时，存储已存在的音频文件名字到共享 Group，然后在 Extension 中通过 Group 获取音频文件名字判断： <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 存储已存在的音频文件名字到共享 Group, 在 App 打开时调用</span></span><br><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">updateAppMainBundleMP3FileResources</span>()</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> path <span class="operator">=</span> <span class="type">Bundle</span>.main.bundlePath</span><br><span class="line">     <span class="keyword">let</span> fileManager <span class="operator">=</span> <span class="type">FileManager</span>.default</span><br><span class="line">     <span class="keyword">do</span> &#123;</span><br><span class="line">         <span class="keyword">let</span> allContentList <span class="operator">=</span> <span class="keyword">try</span> fileManager.contentsOfDirectory(atPath: path)</span><br><span class="line">         <span class="keyword">let</span> validContentList <span class="operator">=</span> allContentList.filter &#123; <span class="variable">$0</span>.hasSuffix(<span class="string">&quot;.mp3&quot;</span>) &#125;</span><br><span class="line">         <span class="built_in">print</span>(validContentList)</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">let</span> shareDefaults <span class="operator">=</span> <span class="type">UserDefaults</span>(suiteName: shareDefaultsSuiteName())</span><br><span class="line">         shareDefaults<span class="operator">?</span>.setValue(validContentList, forKey: kMainAppMp3FileKey)</span><br><span class="line">         shareDefaults<span class="operator">?</span>.synchronize()</span><br><span class="line">     &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">         <span class="built_in">print</span>(error)</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 共享的Group</span></span><br><span class="line"> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">shareDefaultsSuiteName</span>()</span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> name <span class="operator">=</span> <span class="string">&quot;group.com.xxx.pushGroup&quot;</span></span><br><span class="line">     <span class="keyword">return</span> name</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li>判断APP 的<code>Library/Sounds</code>下有没有对应音频文件，这一步需要考虑，是否采用了 APP提供单独接口下发语音文件链接，如果没有，则不需要考虑；笔者这里没有，所以不做详细演示。其逻辑大致如下：<ul>
<li>获取项目<code>Library/Sounds</code>文件夹</li>
<li>获取文件夹下所有音频文件</li>
<li>合并存储音频文件名字到共享 Group 中</li>
</ul>
</li>
<li>判断共享Group的<code>Library/Sounds</code>中有没有已下载过： <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fileprivate</span> <span class="keyword">static</span> <span class="keyword">let</span> kMainAppMp3FileKey <span class="operator">=</span> <span class="string">&quot;kMainAppMp3FileKey&quot;</span></span><br><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">isVoiceInfoExist</span>(<span class="params">voiceName</span>: <span class="type">String</span>)</span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     The /Library/Sounds directory of the app’s container directory.</span></span><br><span class="line"><span class="comment">     The /Library/Sounds directory of one of the app’s shared group container directories.</span></span><br><span class="line"><span class="comment">     The main bundle of the current executable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 判断bundle中有没有</span></span><br><span class="line">    <span class="keyword">let</span> soundStr <span class="operator">=</span> voiceName <span class="operator">+</span> <span class="string">&quot;.mp3&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> shareDefaults <span class="operator">=</span> <span class="type">UserDefaults</span>(suiteName: shareDefaultsSuiteName())</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> validContentList <span class="operator">=</span> shareDefaults<span class="operator">?</span>.value(forKey: kMainAppMp3FileKey) <span class="keyword">as?</span> [<span class="type">String</span>],</span><br><span class="line">        validContentList.contains(soundStr) &#123;</span><br><span class="line">        <span class="comment">// 文件存在</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断 /Library/Sounds 文件夹下有没有</span></span><br><span class="line">    <span class="keyword">let</span> fileManager <span class="operator">=</span> <span class="type">FileManager</span>.default</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> soundsDirectoryURL <span class="operator">=</span> getLibrarySoundsDir() &#123;</span><br><span class="line">        <span class="keyword">let</span> filePath <span class="operator">=</span> (soundsDirectoryURL <span class="keyword">as</span> <span class="type">NSString</span>).appendingPathComponent(voiceName <span class="operator">+</span> <span class="string">&quot;.mp3&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;------&quot;</span>, filePath)</span><br><span class="line">        <span class="keyword">if</span> fileManager.fileExists(atPath: filePath) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 文件不存在存在</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取共享 Group 的`Library/Sounds`文件夹</span></span><br><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">getLibrarySoundsDir</span>()</span> -&gt; <span class="type">String</span>? &#123;</span><br><span class="line">    <span class="keyword">let</span> fileManager <span class="operator">=</span> <span class="type">FileManager</span>.default</span><br><span class="line">    <span class="keyword">let</span> groupIdentifer <span class="operator">=</span> shareDefaultsSuiteName()</span><br><span class="line">    <span class="keyword">let</span> sharedContainerURL: <span class="type">URL</span>? <span class="operator">=</span> fileManager.containerURL(forSecurityApplicationGroupIdentifier: groupIdentifer)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> soundsDirectoryURL <span class="operator">=</span> sharedContainerURL<span class="operator">?</span>.appendingPathComponent(<span class="string">&quot;Library/Sounds&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> fileExist <span class="operator">=</span> fileManager.fileExists(atPath: soundsDirectoryURL.path)</span><br><span class="line">        <span class="keyword">if</span> <span class="operator">!</span>fileExist &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> fileManager.createDirectory(atPath: soundsDirectoryURL.path,</span><br><span class="line">                                                withIntermediateDirectories: <span class="literal">true</span>)</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(error)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> soundsDirectoryURL.path</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>下载音频文件 <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 下载音频文件</span></span><br><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">downloadAndSave</span>(<span class="params">url</span>: <span class="type">URL</span>, <span class="params">voiceName</span>: <span class="type">String</span>, <span class="params">handler</span>: <span class="keyword">@escaping</span> (<span class="keyword">_</span> localURL: <span class="type">URL</span>?) -&gt; <span class="type">Void</span>)</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> task <span class="operator">=</span> <span class="type">URLSession</span>.shared.dataTask(with: url) &#123; data, res, error <span class="keyword">in</span></span><br><span class="line">         <span class="keyword">var</span> localURL: <span class="type">URL</span>?</span><br><span class="line">         <span class="keyword">if</span> <span class="keyword">let</span> data <span class="operator">=</span> data &#123;</span><br><span class="line">             <span class="keyword">let</span> librarySoundDir <span class="operator">=</span> getLibrarySoundsDir()</span><br><span class="line">             <span class="keyword">let</span> filePath <span class="operator">=</span> (librarySoundDir <span class="keyword">as?</span> <span class="type">NSString</span>)<span class="operator">?</span>.appendingPathComponent(voiceName <span class="operator">+</span> <span class="string">&quot;.mp3&quot;</span>)</span><br><span class="line">             <span class="keyword">if</span> <span class="keyword">let</span> urlStr <span class="operator">=</span> filePath &#123;</span><br><span class="line">                 <span class="keyword">let</span> targetUrl <span class="operator">=</span> <span class="type">URL</span>(fileURLWithPath: urlStr)</span><br><span class="line">                 <span class="keyword">do</span> &#123;</span><br><span class="line">                     <span class="keyword">_</span> <span class="operator">=</span> <span class="keyword">try</span> data.write(to: targetUrl)</span><br><span class="line">                 &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                     <span class="built_in">print</span>(error)</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="built_in">print</span>(<span class="string">&quot;url------&quot;</span>, targetUrl)</span><br><span class="line">                 localURL <span class="operator">=</span> targetUrl</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         handler(localURL)</span><br><span class="line">     &#125;</span><br><span class="line">     task.resume()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li>最后统一调用 <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UserNotifications</span><br><span class="line"><span class="keyword">import</span> AVFoundation</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotificationServiceUtil</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">func</span> <span class="title">playVoice</span>(<span class="params">with</span> <span class="params">bestAttemptContent</span>: <span class="type">UNMutableNotificationContent</span>, <span class="params">withContentHandler</span> <span class="params">contentHandler</span>: <span class="keyword">@escaping</span> (<span class="type">UNNotificationContent</span>) -&gt; <span class="type">Void</span>)</span> &#123;</span><br><span class="line">       <span class="keyword">let</span> userInfo <span class="operator">=</span> bestAttemptContent.userInfo</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">do</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> <span class="type">AVAudioSession</span>.sharedInstance().setCategory(<span class="type">AVAudioSession</span>.<span class="type">Category</span>.playback)</span><br><span class="line">           <span class="keyword">try</span> <span class="type">AVAudioSession</span>.sharedInstance().setActive(<span class="literal">true</span>)</span><br><span class="line">       &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">           <span class="built_in">print</span>(error)</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// 要播放的语音文件名字</span></span><br><span class="line">       <span class="keyword">guard</span> <span class="keyword">let</span> voiceName <span class="operator">=</span> userInfo[<span class="string">&quot;voiceName&quot;</span>] <span class="keyword">as?</span> <span class="type">String</span> <span class="keyword">else</span> &#123;</span><br><span class="line">           contentHandler(bestAttemptContent)</span><br><span class="line">           <span class="keyword">return</span></span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// 判断本地是否有语音文件, 有则播放; 没有则下载或者尝试系统语音播放</span></span><br><span class="line">       <span class="keyword">let</span> isVoiceExists <span class="operator">=</span> <span class="type">NotificationServiceUtil</span>.isVoiceInfoExist(voiceName: voiceName)</span><br><span class="line">       <span class="keyword">let</span> soundStr <span class="operator">=</span> voiceName <span class="operator">+</span> <span class="string">&quot;.mp3&quot;</span></span><br><span class="line">       <span class="keyword">let</span> soundName <span class="operator">=</span> <span class="type">UNNotificationSoundName</span>(soundStr)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> isVoiceExists &#123;</span><br><span class="line">           bestAttemptContent.sound <span class="operator">=</span> <span class="type">UNNotificationSound</span>(named: soundName)</span><br><span class="line">           contentHandler(bestAttemptContent)</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 下载链接</span></span><br><span class="line">           <span class="keyword">if</span> <span class="keyword">let</span> voiceUrlStr <span class="operator">=</span> userInfo[<span class="string">&quot;voiceUrl&quot;</span>] <span class="keyword">as?</span> <span class="type">String</span>,</span><br><span class="line">               <span class="keyword">let</span> voiceUrlUrl <span class="operator">=</span> <span class="type">URL</span>(string: voiceUrlStr) &#123;</span><br><span class="line">               <span class="comment">// 下载</span></span><br><span class="line">               <span class="type">NotificationServiceUtil</span>.downloadAndSave(url: voiceUrlUrl, voiceName: voiceName) &#123; localURL <span class="keyword">in</span></span><br><span class="line">                   bestAttemptContent.sound <span class="operator">=</span> <span class="type">UNNotificationSound</span>(named: soundName)</span><br><span class="line">                   contentHandler(bestAttemptContent)</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               contentHandler(bestAttemptContent)</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在<code>NotificationService</code>中调用 <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">import</span> UserNotifications</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">NotificationService</span>: <span class="title">UNNotificationServiceExtension</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> contentHandler: ((<span class="type">UNNotificationContent</span>) -&gt; <span class="type">Void</span>)<span class="operator">?</span></span><br><span class="line">    <span class="keyword">var</span> bestAttemptContent: <span class="type">UNMutableNotificationContent</span>?</span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">lazy</span> <span class="keyword">var</span> util <span class="operator">=</span> <span class="type">NotificationServiceUtil</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceive</span>(<span class="keyword">_</span> <span class="params">request</span>: <span class="type">UNNotificationRequest</span>, <span class="params">withContentHandler</span> <span class="params">contentHandler</span>: <span class="keyword">@escaping</span> (<span class="type">UNNotificationContent</span>) -&gt; <span class="type">Void</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.contentHandler <span class="operator">=</span> contentHandler</span><br><span class="line">        bestAttemptContent <span class="operator">=</span> (request.content.mutableCopy() <span class="keyword">as?</span> <span class="type">UNMutableNotificationContent</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> bestAttemptContent <span class="operator">=</span> bestAttemptContent &#123;</span><br><span class="line">            <span class="comment">// 播放处理</span></span><br><span class="line">            util.playVoice(with: bestAttemptContent, withContentHandler: contentHandler)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">serviceExtensionTimeWillExpire</span>()</span> &#123;</span><br><span class="line">        <span class="comment">// Called just before the extension will be terminated by the system.</span></span><br><span class="line">        <span class="comment">// Use this as an opportunity to deliver your &quot;best attempt&quot; at modified content, otherwise the original push payload will be used.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> contentHandler <span class="operator">=</span> contentHandler, <span class="keyword">let</span> bestAttemptContent <span class="operator">=</span>  bestAttemptContent &#123;</span><br><span class="line">            contentHandler(bestAttemptContent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>iOS语音播报支持方式总结如下：</p>
<p><img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/iOS%E8%AF%AD%E9%9F%B3%E6%92%AD%E6%8A%A5.png" alt="iOS 语音播报"></p>
<p>iOS 语音播报实现流程如下：<br><img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/%E8%AF%AD%E9%9F%B3%E6%92%AD%E6%94%BE%E5%AE%9E%E7%8E%B0%E9%80%BB%E8%BE%91.png" alt="iOS 语音播放实现流程"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://morganwang.cn">今是昨非</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://morganwang.cn/2023/03/22/iOS%E6%8E%A8%E9%80%81%E8%AF%AD%E9%9F%B3%E6%92%AD%E6%8A%A5%E6%9B%B4%E6%96%B0/">http://morganwang.cn/2023/03/22/iOS%E6%8E%A8%E9%80%81%E8%AF%AD%E9%9F%B3%E6%92%AD%E6%8A%A5%E6%9B%B4%E6%96%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://morganwang.cn" target="_blank">今是昨非的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%8A%80%E6%9C%AF/">技术</a><a class="post-meta__tags" href="/tags/iOS/">iOS</a></div><div class="post-share"><div class="social-share" data-image="/assets/img/avatar.jpeg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/03/23/Safari%E4%B8%AD%E4%BD%BF%E7%94%A8NewBing/" title="Safari中使用NewBing"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Safari中使用NewBing</div></div><div class="info-2"><div class="info-item-1">NewBing 的权限已经有了，但是想在 Safari 中使用 NewBing，因为不想日常开三个浏览器，Safari、Chrome、Edge，电脑内存不允许。。。   首先说步骤：  Safari 安装 Microsoft Bing for Safari插件，并登录，能使用NewBing的账号 修改 Safari 的 UserAgent 为 Edge 的 UserAgent 修改默认搜索引擎为Bing  第一步很简单，就打开商店搜索安装即可，安装完成后，打开 bing并登录有NewBing权限的账号； 麻烦的是第二步，网上搜索到大部分是，打开Safari -&gt; Develop -&gt; User Agent -&gt; Microsoft Edge，如下图： 但是这种方法只能在当前Tab页生效，打开新的页面后，就失败了，每个新 Tab 都单独设置一次，想想就不可能。所以有没有一种可以永久设置Safari的 UserAgent的方法？ 当然有了，设置方法如下，设置之后，每次打开新的页面，UserAgent也会一直保持； 永久设置 Safari 的 UserAgent 1d...</div></div></div></a><a class="pagination-related" href="/2023/03/02/openai%E5%92%8CchatGpt%E7%9A%84%E4%BD%BF%E7%94%A8/" title="玩转OpenAI和ChatGpt"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">玩转OpenAI和ChatGpt</div></div><div class="info-2"><div class="info-item-1">背景之前在其他平台就看到有大佬分享自己的ChatGPT的使用, 比如: 自力hzlzh, 但一直也没弄. 昨天突然看到 OpenAI 在商店有很多应用, 下载了一个发现里面接口都是失败的, 但是界面和方向感觉很有意思, 打算自己做一个自用的.    注册 OpenAI注册过程参考超详细注册OpenAI接口账号的教程, 很详细, 按照步骤一步步来即可, 要注意的国内的手机号收不到验证码, 所以需要国外的手机号或者通过接码平台(需付费), 验证码的接收我选用的US的手机号,  花费了 7.1元, 一次就成功了. 简单的说:  首先要能打开openAI的注册页面, 然后注册, 到接收验证码界面 如果有国外的手机号, 直接输入, 接收验证码; 如果没有, 再去注册一个接码平台, 选择语言为中文, 然后就都能看懂了, 然后充值 1 美元, 可以用支付宝支付, 然后搜索openai的接码, 选择一个, 耐心等待, 收到分配的号码之后 再去openAI的验证码界面, 输入分配的号码, 发送验证码, 然后等待, 在接码平台就会显示收到的验证码, 输入就可以注册成功.  如何使用OpenAI注册完...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2019/09/08/CocoaPods%E7%A7%81%E6%9C%89%E5%BA%93%E7%94%9F%E6%88%90/" title="CocoaPods私有库生成"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-08</div><div class="info-item-2">CocoaPods私有库生成</div></div><div class="info-2"><div class="info-item-1">CocoaPods私有库生成</div></div></div></a><a class="pagination-related" href="/2023/02/22/CABasicAnimation%E8%BF%9B%E5%85%A5%E4%BA%8C%E7%BA%A7%E7%95%8C%E9%9D%A2%E5%86%8D%E5%9B%9E%E6%9D%A5%E4%B8%8D%E7%94%9F%E6%95%88/" title="CABasicAnimation进入二级界面再回来不生效"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-22</div><div class="info-item-2">CABasicAnimation进入二级界面再回来不生效</div></div><div class="info-2"><div class="info-item-1">背景发现之前同事写的某个界面有个动效, 起初进入的时候是生效的, 进入二级界面再返回动效就没了, 动画用的是CABasicAnimation, 添加在 layer 上面.    解决看代码没有问题, 毕竟第一次就生效了, 以为是在页面消失时做了什么操作, 查了之后发现, 页面消失时并没有操作. 再回过来看代码, 代码动画部分是在didMoveToWindow中实现的, 大致如下: didMoveToWindow方法在页面消失和出现的时候都会调用, 难道是添加多次导致不生效了, 改成只添加一次之后发现效果一样, 进入二级页面再返回就不生效了. 1234567891011override func didMoveToWindow() &#123;     layer.addSublayer(gradientLayer)     let basicAnim = CABasicAnimation(keyPath: &quot;animateLocation&quot;)     basicAnim.fromValue = [xxx]     basicAnim.toValue = [xx...</div></div></div></a><a class="pagination-related" href="/2024/03/13/Xcode%2015.3%20Archive%E5%A4%B1%E8%B4%A5/" title="Xcode 15.3 Archive失败"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-13</div><div class="info-item-2">Xcode 15.3 Archive失败</div></div><div class="info-2"><div class="info-item-1">Xcode 15.3 Archive失败背景昨晚升级 Xcode 到 15.3，今天打包的时候发现 Archive 失败，提示：Call parameter type does not match function signature!，仔细看报错里是和HandyJSON相关的提示。   解决起初以为和 Pod 库有关系，但是找同事确认后，发现低于 Xcode 15.3 的版本是可以打包成功的，但是 Xcode 15.3 的版本就报错了。然后搜索HandyJSON Call parameter type does not match function signature!，发现了这个，Building HandyJSON in Swift 5.10 throws a fatal error ，是Swift 5.10 编译 HandyJSON报错了。目前HandyJSON官方还未解决。 暂时的解决方法是： 在 Pod 的 Target 中找到 HandyJSON, 然后设置Optimization Level为 None和No Optimization，如下图：  然后再次尝试 A...</div></div></div></a><a class="pagination-related" href="/2022/01/06/Swift%20%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F/" title="Swift后缀表达式(逆波兰式)转换计算"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-06</div><div class="info-item-2">Swift后缀表达式(逆波兰式)转换计算</div></div><div class="info-2"><div class="info-item-1">Swift后缀表达式(逆波兰式)转换计算背景最近在开发《挑战24点》的过程中遇到了一个问题，即，如何计算常用数学表达式的结果，即，给定字符串8 - (6 + 4 / 2 - 1) * 2，怎么计算得到结果，并且得到计算的过程。 网上查资料发现，大部分都是类似系统计算器的处理，在遇到第二个运算符时，就把前一步的操作结果计算出来。这样的处理方式并不适用于笔者想要解决的问题。   进一步搜索后发现，前缀表达式、中缀表达式、后缀表达式的概念，给定的字符串8 - (6 + 4 / 2 - 1) * 2属于中缀表达式，而想要计算机得出结果，可以转为前缀表达式或者后缀表达式，然后再对转换后的表达式进行计算。     这里采用中缀表达式转后缀表达式，然后计算后缀表达式得出结果，步骤如下。 Swift 中缀表达式转后缀表达式什么是中缀表达式、后缀表达式？首先理解中缀表达式和后缀表达式分别是什么？  中缀表达式: 是常用的算术表示方法，操作符处于操作数的中间，比如 (a + b)，即中缀形式，故而称之为中缀表达式。 后缀表达式: 运算符写在操作数之后，比如 (a, b, +)，称之为后缀表达式，又名...</div></div></div></a><a class="pagination-related" href="/2019/09/28/Mapping%20architecture%20armv7%20to%20i386/" title="Mapping architecture armv7 to i386"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-28</div><div class="info-item-2">Mapping architecture armv7 to i386</div></div><div class="info-2"><div class="info-item-1">最近项目里升级后，编译警告多了起来，看起来好碍眼，就想着改掉，先从Debug warning: Mapping architecture armv7 to i386.这个开始。   看了警告之后，知道是对应target下的Build Settings里architecture的问题，然后去检查对应target下，发现today widget、iwatch widget里Valid Architectures的Release跟Debug不一致，然后就手动修改为 $(ARCHS_STANDARD)，编译，done，完美解决。 </div></div></div></a><a class="pagination-related" href="/2024/06/07/Safari%20%E8%8E%B7%E5%8F%96%20Bing%20Rewards%20%E6%8F%92%E4%BB%B6/" title="Safari 获取 Bing Rewards 插件"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-07</div><div class="info-item-2">Safari 获取 Bing Rewards 插件</div></div><div class="info-2"><div class="info-item-1">背景Bing Rewards 可以兑换天猫礼品卡、中国石化礼品卡、肯德基电子券、盒马礼品卡、苹果礼品卡等。level 1 的时候每天至多获取 30 积分，level 2 的可以电脑端 90积分、手机端60 积分。每天150 积分点着太累了，就想着有没有一键的便捷操作。    找到了一个通过 Chrome 插件Rewards-Search-Automator: Chrome / Edge extension for automatic Bing Search，来实现的，除去其中的 Mobile 不生效，外加搜索完成跳转开发者的网站，别的还好，可以自己下载代码，修改去掉跳转开发者网站的逻辑。 但是就是还有个问题，在 iPhone 上用不了，所以手机端的 60 积分还是不能一键获取，所以就想到了，借鉴这个做个 Safari 插件，然后就可以在iPhone上用了。 实现逻辑很简单，iPhone 使用 Bing 搜索，然后抓包出请求，然后提取出关键的form，再封装到 Safari Extension 中，当 popup 出来的时候，触发搜索。添加生成随机字符串的逻辑，每隔 6 秒，重新搜...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/assets/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">今是昨非</div><div class="author-info-description">技术分享、生活感悟</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">188</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mokong"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/mokong" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://x.com/morgan2015_wang" target="_blank" title="Twitter"><i class="fab fa-X"></i></a><a class="social-icon" href="mailto:mokong.2015.1992@email.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#iOS%E6%8E%A8%E9%80%81%E6%92%AD%E6%94%BE%E8%AF%AD%E9%9F%B3%E6%92%AD%E6%8A%A5%E6%9B%B4%E6%96%B0"><span class="toc-number">1.</span> <span class="toc-text">iOS推送播放语音播报更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0"><span class="toc-number">2.</span> <span class="toc-text">更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%88%B0-APP-%E7%9A%84Library-Sounds"><span class="toc-number">3.1.</span> <span class="toc-text">下载到 APP 的Library&#x2F;Sounds</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APP%E5%92%8C-Extension%E5%85%B1%E4%BA%ABGroup%E7%9A%84Library-Sounds%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">3.2.</span> <span class="toc-text">APP和 Extension共享Group的Library&#x2F;Sounds文件夹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/22/Google%20Antigravity%20%E7%99%BB%E5%BD%95%E4%B8%8D%E4%BA%86%E8%A7%A3%E5%86%B3/" title="Google 的 Antigravity登录不了解决">Google 的 Antigravity登录不了解决</a><time datetime="2026-01-22T02:48:00.000Z" title="发表于 2026-01-22 10:48:00">2026-01-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/22/%E5%85%B3%E4%BA%8E%20AI%20%E4%B8%8E%E5%BC%80%E5%8F%91/" title="关于 AI 与开发">关于 AI 与开发</a><time datetime="2026-01-22T02:48:00.000Z" title="发表于 2026-01-22 10:48:00">2026-01-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/21/%E8%BF%9E%E5%A4%9C%E5%BC%80%E5%8F%91%E4%BA%86%E4%B8%80%E4%B8%AA%20Mac%20%E4%B8%8A%E4%B9%85%E5%9D%90%E6%8F%90%E9%86%92%E5%B7%A5%E5%85%B7/" title="连夜开发了一个 Mac 上久坐提醒工具">连夜开发了一个 Mac 上久坐提醒工具</a><time datetime="2026-01-21T09:22:00.000Z" title="发表于 2026-01-21 17:22:00">2026-01-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/13/%E9%B8%BF%E8%92%99%E6%88%AA%E5%9B%BE%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7/" title="无标题">无标题</a><time datetime="2025-10-13T07:24:22.000Z" title="发表于 2025-10-13 15:24:22">2025-10-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/28/%E4%BD%BF%E7%94%A8%E4%B8%80%E8%A1%8C%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0OpenConnect%E8%BF%9E%E6%8E%A5%E5%86%85%E7%BD%91/" title="无标题">无标题</a><time datetime="2025-09-28T07:28:52.000Z" title="发表于 2025-09-28 15:28:52">2025-09-28</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2026 By 今是昨非</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 5.4.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3</a></span></div><div class="footer_custom_text"><span>日出江花红胜火，春来江水绿如蓝，能不忆江南</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      false
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>