<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>一文学会iOS画中画浮窗 | 今是昨非的博客</title><meta name="author" content="今是昨非"><meta name="copyright" content="今是昨非"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="背景之前有看到有人用画中画实现时分秒的计时，顺手收藏了，一直没来及看。最近使用《每日英语听力》，突然发现它用画中画实现了听力语句的显示，顿时来了兴趣，所以来研究一下是怎么实现的？顺便也研究下画中画时分秒计时的实现——每次遇到某些平台每天固定时间开抢的时候，我都希望iPhone能够显示具体到秒的计时，这样就能知道什么时候开始点击合适，而不是每次都提前一分钟在那里不停的点点点却什么都抢不到。。。">
<meta property="og:type" content="article">
<meta property="og:title" content="一文学会iOS画中画浮窗">
<meta property="og:url" content="http://morganwang.cn/2022/08/16/iOS%E7%94%BB%E4%B8%AD%E7%94%BB%E6%B5%AE%E7%AA%97%E8%87%AA%E5%AE%9A%E4%B9%89/index.html">
<meta property="og:site_name" content="今是昨非的博客">
<meta property="og:description" content="背景之前有看到有人用画中画实现时分秒的计时，顺手收藏了，一直没来及看。最近使用《每日英语听力》，突然发现它用画中画实现了听力语句的显示，顿时来了兴趣，所以来研究一下是怎么实现的？顺便也研究下画中画时分秒计时的实现——每次遇到某些平台每天固定时间开抢的时候，我都希望iPhone能够显示具体到秒的计时，这样就能知道什么时候开始点击合适，而不是每次都提前一分钟在那里不停的点点点却什么都抢不到。。。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://morganwang.cn/assets/img/avatar.jpeg">
<meta property="article:published_time" content="2022-08-16T02:07:00.000Z">
<meta property="article:modified_time" content="2024-01-22T11:04:42.000Z">
<meta property="article:author" content="今是昨非">
<meta property="article:tag" content="技术">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://morganwang.cn/assets/img/avatar.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "一文学会iOS画中画浮窗",
  "url": "http://morganwang.cn/2022/08/16/iOS%E7%94%BB%E4%B8%AD%E7%94%BB%E6%B5%AE%E7%AA%97%E8%87%AA%E5%AE%9A%E4%B9%89/",
  "image": "http://morganwang.cn/assets/img/avatar.jpeg",
  "datePublished": "2022-08-16T02:07:00.000Z",
  "dateModified": "2024-01-22T11:04:42.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "今是昨非",
      "url": "http://morganwang.cn"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://morganwang.cn/2022/08/16/iOS%E7%94%BB%E4%B8%AD%E7%94%BB%E6%B5%AE%E7%AA%97%E8%87%AA%E5%AE%9A%E4%B9%89/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '一文学会iOS画中画浮窗',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/assets/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">190</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1477346611705-65d1883cee1e);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">今是昨非的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">一文学会iOS画中画浮窗</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">一文学会iOS画中画浮窗</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-16T02:07:00.000Z" title="发表于 2022-08-16 10:07:00">2022-08-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-22T11:04:42.000Z" title="更新于 2024-01-22 19:04:42">2024-01-22</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>之前有看到有人用画中画实现时分秒的计时，顺手收藏了，一直没来及看。最近使用《每日英语听力》，突然发现它用画中画实现了听力语句的显示，顿时来了兴趣，所以来研究一下是怎么实现的？顺便也研究下画中画时分秒计时的实现——每次遇到某些平台每天固定时间开抢的时候，我都希望iPhone能够显示具体到秒的计时，这样就能知道什么时候开始点击合适，而不是每次都提前一分钟在那里不停的点点点却什么都抢不到。。。</p>
<span id="more"></span>


<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>画中画一般是用来浮窗播放视频的，那如何让画中画播放自定义的界面而不是视频？下面分为5步具体来看下：</p>
<ol>
<li>实现画中画功能，需要设置哪些开关，实现哪些方法；</li>
<li>基本的使用系统播放器时，画中画的实现；</li>
<li>自定义播放器时，画中画功能的实现又需要如何设置，有哪些不同；</li>
<li>如何通过画中画实现时分秒计时功能；</li>
<li>《每日英语听力》通过画中画播放英语听力语句时怎么实现的？</li>
</ol>
<h3 id="APP支持画中画功能"><a href="#APP支持画中画功能" class="headerlink" title="APP支持画中画功能"></a>APP支持画中画功能</h3><p>如何让APP支持画中画功能？首先需要设置App支持<code>BackgroundModes</code>，然后勾选<code>BackgroundModes</code>中的<code>Audio, Airplay, and Picture in Picture</code>。</p>
<p>操作如下：</p>
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/Xnip2022-08-13_09-16-33.jpg" width="70%">

<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/Xnip2022-08-13_09-18-32.jpg" width="70%">

<p>然后需要设置<code>AVAudioSession</code>，在<code>AppDelegate.Swift</code>中<code>application(_:didFinishLaunchingWithOptions:)</code>方法设置如下代码：</p>
<ol>
<li>导入<code>AVFoundation</code></li>
<li>设置<code>AVAudioSession</code>支持后台播放</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 导入AVFoundation</span></span><br><span class="line"><span class="keyword">import</span> AVFoundation</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">application</span>(<span class="keyword">_</span> <span class="params">application</span>: <span class="type">UIApplication</span>, <span class="params">didFinishLaunchingWithOptions</span> <span class="params">launchOptions</span>: [<span class="type">UIApplication</span>.<span class="params">LaunchOptionsKey</span>: <span class="keyword">Any</span>]<span class="operator">?</span>)</span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加设置代码</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// 设置AVAudioSession.Category.playback后，在静音模式下，或者APP进入后台，或者锁定屏幕后还可以继续播放。</span></span><br><span class="line">            <span class="keyword">try</span> <span class="type">AVAudioSession</span>.sharedInstance().setCategory(<span class="type">AVAudioSession</span>.<span class="type">Category</span>.playback, mode: <span class="type">AVAudioSession</span>.<span class="type">Mode</span>.moviePlayback)</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用系统播放器时画中画的实现"><a href="#使用系统播放器时画中画的实现" class="headerlink" title="使用系统播放器时画中画的实现"></a>使用系统播放器时画中画的实现</h3><p>使用系统播放器<code>AVPlayerViewController</code>来实现播放器画中画，首先导入<code>AVKit</code>，获取要播放的资源，然后使用<code>AVPlayerViewController</code>来进行播放，代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> AVKit</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 获取播放的资源</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">playerResource</span>()</span> -&gt; <span class="type">AVQueuePlayer</span>? &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> videoURL <span class="operator">=</span> <span class="type">Bundle</span>.main.url(forResource: <span class="string">&quot;suancaidegang&quot;</span>, withExtension: <span class="string">&quot;mp4&quot;</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> item <span class="operator">=</span> <span class="type">AVPlayerItem</span>(url: videoURL)</span><br><span class="line">        <span class="keyword">let</span> player <span class="operator">=</span> <span class="type">AVQueuePlayer</span>(playerItem: item)</span><br><span class="line">        player.actionAtItemEnd <span class="operator">=</span> .pause</span><br><span class="line">        <span class="keyword">return</span> player</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">systemPlayerAction</span>(<span class="keyword">_</span> <span class="params">sender</span>: <span class="keyword">Any</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> player <span class="operator">=</span> playerResource() <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> avPlayerVC <span class="operator">=</span> <span class="type">AVPlayerViewController</span>()</span><br><span class="line">        avPlayerVC.player <span class="operator">=</span> player</span><br><span class="line">        present(avPlayerVC, animated: <span class="literal">true</span>) &#123;</span><br><span class="line">            player.play()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里需要注意的是，一定要在真机上才可以看到画中画的效果，使用模拟器不行。运行后可以看到<code>AVPlayerViewController</code>直接支持了画中画的播放；点击进入画中画后，之前全屏的播放界面自动关掉；点击画中画返回播放界面后，画中画关闭，但是之前的播放界面也没有重新打开，效果如下：</p>
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/AVPlayerViewController%E6%B2%A1%E8%AE%BE%E7%BD%AE%E6%97%B6%E6%95%88%E6%9E%9C.gif" height="500px">

<p>而这里很明显，画中画返回不了之前的播放界面是有问题的，所以要修改一下，加入可以设置再进入画中画时全屏的播放界面不关闭，点击画中画的返回是否可以正常呢？这里<code>AVPlayerViewControllerDelegate</code>的方法<code> playerViewControllerShouldAutomaticallyDismissAtPictureInPictureStart(_ playerViewController: AVPlayerViewController) -&gt; Bool</code>可以控制进入画中画时是否关闭当前界面。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 在此方法中添加avPlayerVC.delegate = self</span></span><br><span class="line"> <span class="keyword">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">systemPlayerAction</span>(<span class="keyword">_</span> <span class="params">sender</span>: <span class="keyword">Any</span>)</span> &#123;</span><br><span class="line">     <span class="keyword">guard</span> <span class="keyword">let</span> player <span class="operator">=</span> playerResource() <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">let</span> avPlayerVC <span class="operator">=</span> <span class="type">AVPlayerViewController</span>()</span><br><span class="line">     avPlayerVC.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">     avPlayerVC.player <span class="operator">=</span> player</span><br><span class="line">     present(avPlayerVC, animated: <span class="literal">true</span>) &#123;</span><br><span class="line">         player.play()</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 设置AVPlayerViewControllerDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">AVPlayerViewControllerDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">playerViewControllerShouldAutomaticallyDismissAtPictureInPictureStart</span>(<span class="keyword">_</span> <span class="params">playerViewController</span>: <span class="type">AVPlayerViewController</span>)</span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">         <span class="comment">// 返回false时，进入画中画后播放界面不关闭</span></span><br><span class="line">         <span class="comment">// 返回true时，进入画中画后播放界面自动关闭，默认为true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行调试效果，可以看到，进入画中画时，播放界面没关闭，显示<code>This video is playing in picture in picture</code>，且没有关闭按钮；画中画返回时，播放界面可以继续接着播放。效果如下：</p>
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/AVPlayer%E8%AE%BE%E7%BD%AE%E6%95%88%E6%9E%9C.gif" height="500px">

<p>对比如下，没处理前点击进入画中画后界面，原播放界面消失，点击画中画的进入按钮不能进入到播放界面，效果如左侧图片所示。处理后效果如右侧图片所示，进入画中画后，可以返回到全屏播放界面。</p>
<figure>
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/AVPlayerViewController%E6%B2%A1%E8%AE%BE%E7%BD%AE%E6%97%B6%E6%95%88%E6%9E%9C.png" height="500px">
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/AVPlayer%E8%AE%BE%E7%BD%AE%E6%95%88%E6%9E%9C.png" height="500px">
</figure>

<p>但是上面的效果也不是所期望的，通常进入画中画模式，是为了继续操作页面其他的内容，而上面的设置虽然可以让画中画返回时继续播放，但是却也阻碍了操作页面其他的内容，所以还是需要修改。期望的效果是，进入画中画界面，当前播放界面消失；并且从画中画返回时，还可以进入播放界面，下面来看下如何设置实现：</p>
<p>在<code>AVPlayerViewControllerDelegate</code>中有另外一个方法<code>playerViewController(_ playerViewController: AVPlayerViewController, restoreUserInterfaceForPictureInPictureStopWithCompletionHandler completionHandler: @escaping (Bool) -&gt; Void) </code>，画中画点击返回时会触发这个方法，所以要做的内容是，在这个方法被触发时，重新唤起播放视频界面，代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">AVPlayerViewControllerDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">playerViewControllerShouldAutomaticallyDismissAtPictureInPictureStart</span>(<span class="keyword">_</span> <span class="params">playerViewController</span>: <span class="type">AVPlayerViewController</span>)</span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="comment">// 这里修改为返回true，即进入画中画时关闭播放界面</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">playerViewController</span>(<span class="keyword">_</span> <span class="params">playerViewController</span>: <span class="type">AVPlayerViewController</span>, <span class="params">restoreUserInterfaceForPictureInPictureStopWithCompletionHandler</span> <span class="params">completionHandler</span>: <span class="keyword">@escaping</span> (<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)</span> &#123;</span><br><span class="line">        restore(playerVC: playerViewController, completionHandler: completionHandler)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">restore</span>(<span class="params">playerVC</span>: <span class="type">UIViewController</span>, <span class="params">completionHandler</span>: <span class="keyword">@escaping</span> (<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> presentedVC <span class="operator">=</span> presentedViewController &#123;</span><br><span class="line">            <span class="comment">// 说明当前正在播放的界面还存在</span></span><br><span class="line">            <span class="comment">// 先关闭界面，再弹出播放界面</span></span><br><span class="line">            presentedVC.dismiss(animated: <span class="literal">false</span>) &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span><span class="operator">?</span>.present(playerVC, animated: <span class="literal">false</span>) &#123;</span><br><span class="line">                    completionHandler(<span class="literal">true</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 直接弹出播放界面</span></span><br><span class="line">            present(playerVC, animated: <span class="literal">false</span>) &#123;</span><br><span class="line">                completionHandler(<span class="literal">true</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行查看效果，可以看到进入画中画界面，当前播放界面消失；并且从画中画返回时，还可以进入播放界面，完美。演示如下：</p>
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/AVPlayer%E6%9C%80%E7%BB%88%E6%95%88%E6%9E%9C.gif" height="500px">

<p>对比如下，没处理前点击进入画中画后界面，原播放界面消失，点击画中画的进入按钮不能进入到播放界面，效果如左侧图片所示。处理后效果如右侧图片所示，进入画中画后，可以返回到全屏播放界面。</p>
<figure>
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/AVPlayer%E8%AE%BE%E7%BD%AE%E6%95%88%E6%9E%9C.png" height="500px">
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/AVPlayerViewController%E6%B2%A1%E8%AE%BE%E7%BD%AE%E6%97%B6%E6%95%88%E6%9E%9C.png" height="500px">
// Fixed-Me:
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/AVPlayerViewController%E6%B2%A1%E8%AE%BE%E7%BD%AE%E6%97%B6%E6%95%88%E6%9E%9C.png" height="500px">
</figure>

<h3 id="自定义播放器时画中画的实现"><a href="#自定义播放器时画中画的实现" class="headerlink" title="自定义播放器时画中画的实现"></a>自定义播放器时画中画的实现</h3><p>自定义播放器相比于使用系统的<code>AVPlayerViewController</code>，需要在自定义播放器界面实现点击唤起画中画播放，并且实现画中画的代理方法<code>AVPictureInPictureControllerDelegate</code>，在画中画的代理方法中，处理画中画返回时的逻辑。需要着重注意的是，如果设置进入画中画后播放界面消失，则当前的播放界面会被释放掉，会导致播放界面上的画中画播放也会消失，所以需要特殊处理下，声明一个全局的<Set>来存储。参考<a target="_blank" rel="noopener" href="https://www.raywenderlich.com/24247382-picture-in-picture-across-all-platforms">Picture in Picture Across All Platforms</a>。</p>
<p>代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">CustomPlayerVCDelegate</span>: <span class="title">AnyObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">playerViewController</span>(</span></span><br><span class="line"><span class="function">      <span class="keyword">_</span> <span class="params">playerViewController</span>: <span class="type">MWCustomPlayerVC</span>,</span></span><br><span class="line"><span class="function">      <span class="params">restoreUserInterfaceForPictureInPictureStopWithCompletionHandler</span></span></span><br><span class="line"><span class="function">        <span class="params">completionHandler</span>: <span class="keyword">@escaping</span> (<span class="type">Bool</span>) -&gt; <span class="type">Void</span></span></span><br><span class="line"><span class="function">    )</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> activeCustomPlayerVCs <span class="operator">=</span> <span class="type">Set</span>&lt;<span class="type">MWCustomPlayerVC</span>&gt;()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MWCustomPlayerVC</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - properties</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> pictureInPictureVC: <span class="type">AVPictureInPictureController</span>?</span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">CustomPlayerVCDelegate</span>?</span><br><span class="line">    <span class="keyword">var</span> autoDismissAtPip: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">false</span> <span class="comment">// 进入画中画时，是否自动关闭当前播放页面</span></span><br><span class="line">    <span class="keyword">var</span> enterPipBtn: <span class="type">CustomPlayerCircularButtonView</span>?</span><br><span class="line"></span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">        </span><br><span class="line">        view.backgroundColor <span class="operator">=</span> .black</span><br><span class="line">        </span><br><span class="line">        setupPictureInPictureVC()</span><br><span class="line">        setupEnterPipBtn()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">setupPictureInPictureVC</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> playerLayer <span class="operator">=</span> playerLayer <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pictureInPictureVC <span class="operator">=</span> <span class="type">AVPictureInPictureController</span>(playerLayer: playerLayer)</span><br><span class="line">        pictureInPictureVC<span class="operator">?</span>.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">       </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">setupEnterPipBtn</span>()</span> &#123;</span><br><span class="line">        enterPipBtn <span class="operator">=</span> <span class="type">CustomPlayerCircularButtonView</span>(symbolName: <span class="string">&quot;pip.enter&quot;</span>, height: <span class="number">50.0</span>)</span><br><span class="line">        enterPipBtn<span class="operator">?</span>.addTarget(<span class="keyword">self</span>, action: #selector(handleEnterPipAction), for: [.primaryActionTriggered, .touchUpInside])</span><br><span class="line">        view.addSubview(enterPipBtn<span class="operator">!</span>)</span><br><span class="line">        </span><br><span class="line">        enterPipBtn<span class="operator">?</span>.snp.makeConstraints &#123; make <span class="keyword">in</span></span><br><span class="line">            make.right.equalToSuperview().in<span class="keyword">set</span>(<span class="number">10.0</span>)</span><br><span class="line">            make.centerY.equalTo(<span class="keyword">self</span>.view.snp.centerY)</span><br><span class="line">            make.width.height.equalTo(<span class="number">50.0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 点击唤起画中画界面</span></span><br><span class="line">    <span class="keyword">@objc</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">handleEnterPipAction</span>()</span> &#123;</span><br><span class="line">        pictureInPictureVC<span class="operator">?</span>.startPictureInPicture()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MWCustomPlayerVC</span>: <span class="title">AVPictureInPictureControllerDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pictureInPictureControllerWillStartPictureInPicture</span>(<span class="keyword">_</span> <span class="params">pictureInPictureController</span>: <span class="type">AVPictureInPictureController</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 进入画中画播放的代理方法</span></span><br><span class="line">        activeCustomPlayerVCs.insert(<span class="keyword">self</span>)</span><br><span class="line">        enterPipBtn<span class="operator">?</span>.isHidden <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 画中画开始播放后，当前播放界面是否消失</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pictureInPictureControllerDidStartPictureInPicture</span>(<span class="keyword">_</span> <span class="params">pictureInPictureController</span>: <span class="type">AVPictureInPictureController</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> autoDismissAtPip &#123;</span><br><span class="line">            dismiss(animated: <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 画中画进入失败</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pictureInPictureController</span>(<span class="keyword">_</span> <span class="params">pictureInPictureController</span>: <span class="type">AVPictureInPictureController</span>, <span class="params">failedToStartPictureInPictureWithError</span> <span class="params">error</span>: <span class="type">Error</span>)</span> &#123;</span><br><span class="line">        activeCustomPlayerVCs.remove(<span class="keyword">self</span>)</span><br><span class="line">        enterPipBtn<span class="operator">?</span>.isHidden <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 画中画返回的代理方法</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pictureInPictureController</span>(<span class="keyword">_</span> <span class="params">pictureInPictureController</span>: <span class="type">AVPictureInPictureController</span>, <span class="params">restoreUserInterfaceForPictureInPictureStopWithCompletionHandler</span> <span class="params">completionHandler</span>: <span class="keyword">@escaping</span> (<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)</span> &#123;</span><br><span class="line">        delegate<span class="operator">?</span>.playerViewController(<span class="keyword">self</span>, restoreUserInterfaceForPictureInPictureStopWithCompletionHandler: completionHandler)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在外面使用的地方调用，并且处理画中画关闭的回调代理方法，如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">customPlayerAction</span>(<span class="keyword">_</span> <span class="params">sender</span>: <span class="keyword">Any</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> player <span class="operator">=</span> playerResource() <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> playerVC <span class="operator">=</span> <span class="type">MWCustomPlayerVC</span>()</span><br><span class="line">        playerVC.modalPresentationStyle <span class="operator">=</span> .fullScreen</span><br><span class="line">        playerVC.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">        playerVC.player <span class="operator">=</span> player</span><br><span class="line">        playerVC.autoDismissAtPip <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        present(playerVC, animated: <span class="literal">true</span>) &#123;</span><br><span class="line">            player.play()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">CustomPlayerVCDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">playerViewController</span>(</span></span><br><span class="line"><span class="function">      <span class="keyword">_</span> <span class="params">playerViewController</span>: <span class="type">MWCustomPlayerVC</span>,</span></span><br><span class="line"><span class="function">      <span class="params">restoreUserInterfaceForPictureInPictureStopWithCompletionHandler</span></span></span><br><span class="line"><span class="function">      <span class="params">completionHandler</span>: <span class="keyword">@escaping</span> (<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)</span> &#123;</span><br><span class="line">          restore(playerVC: playerViewController, completionHandler: completionHandler)</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行后效果如下，可以看到，自定义的播放器处理后可以和系统自带播放器的画中画效果一样：</p>
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%92%AD%E6%94%BE%E5%99%A8%E7%94%BB%E4%B8%AD%E7%94%BB.gif" height="500px">


<p>在开始下一步之前，希望大家能思考一下：通过上面的画中画例子，已经知道画中画是怎么使用的了。那假如让你来实现一个画中画的计时，你会怎么实现，有哪些方法？</p>
<ul>
<li>笔者想的方法是，既然画中画是播放视频的，那是否可以把view转为视频？然后再用播放视频的方式，来播放view的内容？</li>
<li>然后笔者查阅了网上其他资料，发现还有一种更tricky的思路，既然画中画在APP中弹出，那是不是能获取画中画的window，获取到window之后，直接在window上添加view的显示是不是就可以了？</li>
</ul>
<p>下面就依次来验证一下这两种方法是否都可行？<br>首先画中画的计时，就来验证方法一是否可行；《每日英语听力》语句的展示，来验证方法二是否可行。</p>
<h3 id="时分秒计时画中画的实现"><a href="#时分秒计时画中画的实现" class="headerlink" title="时分秒计时画中画的实现"></a>时分秒计时画中画的实现</h3><p>这里使用方法一，即把view转为视频，再用播放视频的方式来播放view的内容，来实现一个计时器。那么问题是如何把view转为视频？</p>
<p>查找不到直接的转换方法，但是参考<a target="_blank" rel="noopener" href="https://github.com/uakihir0/UIPiPView">UIPiPView</a>，可以发现里面是</p>
<ol>
<li>把<code>view</code>转为<code>CMSampleBuffer</code>（参考<a target="_blank" rel="noopener" href="https://soranoba.net/programming/uiview-to-cmsamplebuffer%EF%BC%89">https://soranoba.net/programming/uiview-to-cmsamplebuffer）</a></li>
<li>通过<code>initWithSampleBufferDisplayLayer</code>方法用<code>AVSampleBufferDisplayLayer</code>来初始化<code>AVPictureInPictureController.ContentSource</code>，</li>
<li>再用<code>AVPictureInPictureController.ContentSource</code>来初始化<code>AVPictureInPictureController</code>，</li>
<li>然后用<code>AVSampleBufferDisplayLayer</code>来展示<code>CMSampleBuffer</code>，</li>
<li>最终把view显示在了<code>AVPictureInPictureController</code>上。</li>
</ol>
<p>这里需要注意的一个问题是，上面的把<code>view</code>转为<code>CMSampleBuffer</code>，再把<code>CMSampleBuffer</code>显示到<code>AVPictureInPictureController</code>上的过程只是单个view，而如何变成一个流畅的视频播放呢？需要定义不断的刷新timer，那刷新的timer的间隔多少合适呢？肉眼看不到卡顿就合适，<code>UIPiPView</code>中推荐使用0.1/60秒。</p>
<p>这里就不再重复封装，直接使用<a target="_blank" rel="noopener" href="https://github.com/uakihir0/UIPiPView">UIPiPView</a>，然后创建一个计时器，需要注意的是要显示的view是添加在<code>UIPipView</code>上。</p>
<p>代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> UIPiPView</span><br><span class="line"><span class="keyword">import</span> SnapKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MWFullTimerVC</span>: <span class="title">MWBaseVC</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - properties</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> pipView <span class="operator">=</span> <span class="type">UIPiPView</span>()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> timeLabel <span class="operator">=</span> <span class="type">UILabel</span>()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> dateFormatStr <span class="operator">=</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> timer: <span class="type">Timer</span>?</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - view life cycle</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">        view.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.black</span><br><span class="line">        </span><br><span class="line">        setupPipView()</span><br><span class="line">        setupTimeLabel()</span><br><span class="line">        createDisplayLink()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">setupPipView</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> width <span class="operator">=</span> <span class="type">UIScreen</span>.main.bounds.width</span><br><span class="line">        pipView.frame <span class="operator">=</span> <span class="type">CGRect</span>(x: <span class="number">10.0</span>, y: <span class="number">0</span>, width: width <span class="operator">-</span> <span class="number">20.0</span>, height: <span class="number">50.0</span>)</span><br><span class="line">        view.addSubview(pipView)</span><br><span class="line">        pipView.snp.makeConstraints &#123; make <span class="keyword">in</span></span><br><span class="line">            make.leading.trailing.equalToSuperview().in<span class="keyword">set</span>(<span class="number">10.0</span>)</span><br><span class="line">            make.top.equalToSuperview().in<span class="keyword">set</span>(<span class="number">100.0</span>)</span><br><span class="line">            make.height.equalTo(<span class="number">50.0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">setupTimeLabel</span>()</span> &#123;</span><br><span class="line">        timeLabel.font <span class="operator">=</span> <span class="type">UIFont</span>.boldSystemFont(ofSize: <span class="number">16.0</span>)</span><br><span class="line">        timeLabel.textColor <span class="operator">=</span> <span class="type">UIColor</span>.white</span><br><span class="line">        timeLabel.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.orange</span><br><span class="line">        timeLabel.textAlignment <span class="operator">=</span> .center</span><br><span class="line">        pipView.addSubview(timeLabel)</span><br><span class="line">        timeLabel.snp.makeConstraints &#123; make <span class="keyword">in</span></span><br><span class="line">            make.leading.trailing.equalToSuperview()</span><br><span class="line">            make.top.equalToSuperview()</span><br><span class="line">            make.height.equalToSuperview()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">createDisplayLink</span>()</span> &#123;</span><br><span class="line">        timer <span class="operator">=</span> <span class="type">Timer</span>(timeInterval: <span class="number">0.1</span><span class="operator">/</span><span class="number">60</span>, repeats: <span class="literal">true</span>, block: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span><span class="operator">?</span>.refresh()</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="type">RunLoop</span>.current.add(timer<span class="operator">!</span>, forMode: <span class="type">RunLoop</span>.<span class="type">Mode</span>.common)</span><br><span class="line">        timer<span class="operator">?</span>.fire()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - init</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - utils</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">reloadTime</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> date <span class="operator">=</span> <span class="type">Date</span>()</span><br><span class="line">        <span class="keyword">let</span> formatter <span class="operator">=</span> <span class="type">DateFormatter</span>()</span><br><span class="line">        formatter.dateFormat <span class="operator">=</span> dateFormatStr</span><br><span class="line">        <span class="keyword">self</span>.timeLabel.text <span class="operator">=</span> formatter.string(from: date)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - action</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">refresh</span>()</span> &#123;</span><br><span class="line">        reloadTime()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">handleEnterPipAction</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.handleEnterPipAction()</span><br><span class="line">        <span class="keyword">if</span> pipView.isPictureInPictureActive() &#123;</span><br><span class="line">            pipView.stopPictureInPicture()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pipView.startPictureInPicture(withRefreshInterval: <span class="number">0.1</span><span class="operator">/</span><span class="number">60.0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - other</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行后调试效果如下：</p>
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/UIPipView.gif" height="500px">

<p>可以看到上面的方法是可行的，而且画中画的大小是可自己定义的，同时不需要内置空白的视频文件。定义的视图什么样画中画的显示就是什么样。</p>
<h3 id="《每日英语听力》画中画的实现"><a href="#《每日英语听力》画中画的实现" class="headerlink" title="《每日英语听力》画中画的实现"></a>《每日英语听力》画中画的实现</h3><p>这里来验证获取画中画的window，获取到window后直接在window上添加view的显示，从而在画中画中显示自定义view的方式。</p>
<p>在画中画即将展示的代理方法<code>pictureInPictureControllerWillStartPictureInPicture(_ pictureInPictureController: AVPictureInPictureController)</code>中，获取到最上层window，然后添加自定义文字播放view。文字播放view设置每隔2秒播放下一句。</p>
<p>最终整体代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MWPipWindowVC</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setupTextPlayerView</span>(<span class="params">on</span> <span class="params">targetView</span>: <span class="type">UIView</span>)</span> &#123;</span><br><span class="line">        targetView.addSubview(textPlayView)</span><br><span class="line">        textPlayView.text <span class="operator">=</span> text1</span><br><span class="line">        </span><br><span class="line">        textPlayView.snp.makeConstraints &#123; make <span class="keyword">in</span></span><br><span class="line">            make.centerY.equalTo(targetView.snp.centerY)</span><br><span class="line">            make.leading.trailing.equalToSuperview()</span><br><span class="line">            make.height.equalTo(<span class="number">250.0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">setupTimer</span>()</span> &#123;</span><br><span class="line">        timer <span class="operator">=</span> <span class="type">Timer</span>(timeInterval: <span class="number">2.0</span>, repeats: <span class="literal">true</span>, block: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span><span class="operator">?</span>.handleTimerAction()</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="type">RunLoop</span>.current.add(timer<span class="operator">!</span>, forMode: <span class="type">RunLoop</span>.<span class="type">Mode</span>.common)</span><br><span class="line">        timer<span class="operator">?</span>.fire()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - utils</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - action</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handleTimerAction</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> dataList <span class="operator">=</span> [text1, text2, text3, text4, text5]</span><br><span class="line">        count <span class="operator">+=</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">let</span> index <span class="operator">=</span> count <span class="operator">%</span> <span class="number">5</span></span><br><span class="line">        <span class="keyword">let</span> str <span class="operator">=</span> dataList[index]</span><br><span class="line">        textPlayView.text <span class="operator">=</span> str</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MWPipWindowVC</span>: <span class="title">AVPictureInPictureControllerDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pictureInPictureControllerWillStartPictureInPicture</span>(<span class="keyword">_</span> <span class="params">pictureInPictureController</span>: <span class="type">AVPictureInPictureController</span>)</span> &#123;</span><br><span class="line">        activeCustomPlayerVCs.insert(<span class="keyword">self</span>)</span><br><span class="line">        enterPipBtn<span class="operator">?</span>.isHidden <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> window <span class="operator">=</span> <span class="type">UIApplication</span>.shared.windows.first &#123;</span><br><span class="line">            setupTextPlayerView(on: window)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xxx</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行调试，最终效果如下：</p>
<img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/%E7%94%BB%E4%B8%AD%E7%94%BB%E6%92%AD%E6%94%BE%E6%96%87%E5%AD%97.gif" height="500px">

<p>可以看到上面的方法是可行的，但是需要注意的是，这里进入画中画时可以看到播放视频的界面闪了一下，而且画中画的尺寸是和视频尺寸一致的。所以随用这种方法时，需要提前准备好对应尺寸的空白视频，然后使用画中画播放空白视频，再把自定义的view添加到画中画的window上。</p>
<p>对比”view转为视频然后播放”和”播放空白视频然后将view展示在视频上方的window中”这两种实现，首先两者都可以实现自定义画中画展示的效果。但是笔者测试后发现：”view转视频再播放”占用的CPU要比后者高很多，因为需要不断的读取和刷新。而”播放空白视频然后将view展示在视频上方的window中”这种方法虽然占用的CPU低，但是因为依赖空白视频文件，所以安装包体积会被变大，而且如果要有多种样式的画中画效果，就需要多个空白视频文件。</p>
<p>所以两者要如何选择使用哪种方式呢？通常来说，如果没有多个画中画样式的需求，建议选择”播放空白视频然后将view展示在视频上方的window中”；而如果对安装包大小敏感，且需要用户自定义画中画或者有不同样式的画中画需求，则可以考虑使用”view转为视频然后播放”的方法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><img src="https://raw.githubusercontent.com/mokong/BlogImages/main/img/%E7%94%BB%E4%B8%AD%E7%94%BB.png" width="70%">


<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/avkit/adopting_picture_in_picture_in_a_standard_player">Adopting Picture in Picture in a Standard Player</a></li>
<li><a target="_blank" rel="noopener" href="https://www.raywenderlich.com/24247382-picture-in-picture-across-all-platforms">Picture in Picture Across All Platforms</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/uakihir0/UIPiPView">UIPiPView</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/CaiWanFeng/CustomPictureInPicture/blob/master/pip_swift/pip_swift/ViewController.swift">CustomPictureInPicture</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://morganwang.cn">今是昨非</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://morganwang.cn/2022/08/16/iOS%E7%94%BB%E4%B8%AD%E7%94%BB%E6%B5%AE%E7%AA%97%E8%87%AA%E5%AE%9A%E4%B9%89/">http://morganwang.cn/2022/08/16/iOS%E7%94%BB%E4%B8%AD%E7%94%BB%E6%B5%AE%E7%AA%97%E8%87%AA%E5%AE%9A%E4%B9%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://morganwang.cn" target="_blank">今是昨非的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%8A%80%E6%9C%AF/">技术</a><a class="post-meta__tags" href="/tags/iOS/">iOS</a></div><div class="post-share"><div class="social-share" data-image="/assets/img/avatar.jpeg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/08/20/iOS%E8%BE%93%E5%85%A5%E6%A1%86%E5%AD%97%E7%AC%A6%E9%99%90%E5%88%B6/" title="iOS输入框字符限制"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">iOS输入框字符限制</div></div><div class="info-2"><div class="info-item-1">背景小知识点记录，textField的markedTextRange的使用，如果你已经知道了，就不需要再看了。 iOS输入框字符限制，不同实现方式的对比：  方法1，通过监听textField的UIControl.Event.editingChanged，在对应的方法里做长度拦截判断 方法2，通过textField的代理方法，textField(_ textField: UITextField, shouldChangeCharactersIn range: NSRange, replacementString string: String) -&gt; Bool判断。    对比假设产品要求这个输入框限制输入6个字，怎么判断？下面来看下 方法1声明一个自定义的MWCustomTF，然后监听editingChanged事件，在事件里判断输入字符是否超出最大输入长度，代码如下： 123456789101112131415161718192021222324252627282930313233343536class MWCustomTF: UITextField &#123;    ...</div></div></div></a><a class="pagination-related" href="/2022/06/11/iOS%20The%20'Pods-App'%20target%20has%20transitive%20dependencies%20that%20include%20static%20binaries/" title="The 'Pods-App' target has transitive dependencies that include static binaries"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">The 'Pods-App' target has transitive dependencies that include static binaries</div></div><div class="info-2"><div class="info-item-1">The ‘Pods-App’ target has transitive dependencies that include static binaries:修改背景最近遇到了两次次这个问题，都是Swift项目Pod添加库开启了use_frameworks!，安装某些OC库时报错；花了好久时间解决，突然想起来之前OC项目安装Swift库也遇到了这个问题，但是之前没有记录，所以这次遇到时没有印象；这次记录下来，分享给大家：   解决方案之前遇到的是OC代码安装ZLPhotoBrowser的Swift库，开启了use_frameworks!，和其他第三方库一起安装时，可以理解为，除了ZLPhotoBrowser是动态库，其他的第三方库默认都使用static_framework或者static_library。 Pod文件末尾添加下面代码： 12345678910111213141516171819use_frameworks!...dynamic_frameworks = [&#x27;ZLPhotoBrowser&#x27;]pre_install do |installer|  ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2022/08/26/%E5%BD%95%E9%9F%B3%E5%B4%A9%E6%BA%83%E6%8E%92%E6%9F%A5/" title="一次诡异的录音崩溃排查"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-26</div><div class="info-item-2">一次诡异的录音崩溃排查</div></div><div class="info-2"><div class="info-item-1">背景上午突然有用户反馈，使用录音功能崩溃。起初以为是最近更新的APP新版本有问题，赶紧去排查。   排查首先在测试手机上，测试环境调试，发现并没有崩溃，长出了一口气，说明不是所有用户都有，不是新版本改出来的问题。 然后去听云后台看日志，发现崩溃的地方是初始化AVAudioRecorder的方法——[[AVAudioRecorder alloc] initWithURL:url settings:recordSettings error:&amp;error];。很费解，只是简单的初始化方法，为什么会导致崩溃呢？ 一开始猜测会不会是用户录音权限没开，导致开始录音的时候崩溃。尝试后发现如果权限关闭，在进入录音页面前就会提示权限未开启，去开启权限，并不能进入到录音步骤。 然后怀疑会不会是初始化的url为空，又或者机型不支持设置recordSettings中的某些参数？搜索后，发现有url为空崩溃的条目，所以这里大概率也是初始化的url为空。 继续排查，发现初始化的url，是本地的缓存文件夹中Audio文件夹，并且文件名字是取日期+时分秒用于避免重复，格式为yyyyMMdd_HHmmss...</div></div></div></a><a class="pagination-related" href="/2021/08/30/iOS%E5%9C%A8%E6%96%87%E4%BB%B6%E4%B8%AD%E8%AE%BF%E9%97%AEDocument%20Directory/" title="iOS 在文件中访问 Document Directory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-30</div><div class="info-item-2">iOS 在文件中访问 Document Directory</div></div><div class="info-2"><div class="info-item-1">iOS 在文件中访问 Document DirectoryiOS 11之后，在 Plist 中设置LSSupportsOpeningDocumentsInPlace为 YES，且UIFileSharingEnabled为 YES，可以从系统的Files应用中访问应用的 Documents 目录。   如下： 从系统的文件打开，查看我的 iPhone如下，开启了此功能的应用可以从这里面看到      注意：此目录是 APP 的Documents目录，所以 APP 删除后，目录就消失了。 参考： iOS文件共享  </div></div></div></a><a class="pagination-related" href="/2022/04/26/24%E7%82%B9%E7%AE%97%E6%B3%95Swift%20%E5%AE%9E%E7%8E%B0/" title="《24点》APP——提示功能的实现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-26</div><div class="info-item-2">《24点》APP——提示功能的实现</div></div><div class="info-2"><div class="info-item-1">更新：《24点》APP——提示功能实现背景商店里所有24点 APP 的一个付费功能是提示的获取，会通过限制提示次数，超出次数后观看广告或者购买来解锁额外次数。比如：     这里就来分享一下，类似24点的提示功能是怎么实现的，其实现步骤如下： 步骤一：判断结果能不能等于24； 步骤二：如果能等于24，显示出能得到24的表达式。 下面详细记录一下实现的过程： 解法原理步骤一，判断能不能等于24有[a, b, c, d] 四个数字，任取两个数字，通过遍历运算符得到运算结果 e，然后把运算结果和剩余的数字放入新的数组中，重复上面的计算过程，直到数组中有一个元素为止；最后判断数组中唯一的数字是否等于24即可。 这里需要注意几点，一是遍历运算符的时候，加和乘符合交换律，所以不需要重复计算；二是除法会有小数，所以最终判断是否等于24的时候，需要通过设置误差范围来判断；再有就是除法的除数不能为零。 所以最终解法描述如下：  定义误差范围，定义要对比的值，定义运算符数组； 定义判断是否相等的判断方法，传入值和要对比的值的绝对值小于误差范围，即视作相等； 数据转换，由于传入的数字是Int，所以通过...</div></div></div></a><a class="pagination-related" href="/2022/09/14/Xcode14%E7%BC%96%E8%AF%91%E5%A4%B1%E8%B4%A5%E4%BF%AE%E6%94%B9/" title="Xcode14编译失败修改"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-14</div><div class="info-item-2">Xcode14编译失败修改</div></div><div class="info-2"><div class="info-item-1">背景升级Xcode 14后，项目编译失败修改，共修改了两种编译错误：  一种是bundle code sign error，Xcode 14 needs selected Development Team for Pod Bundles 一种是Module compiled with Swift 5.6.1 cannot be imported by the Swift 5.7 compiler    其中第一种比较容易解决，第二种稍微麻烦点，解决方案如下： 解决Xcode 14 bundle code sign error这个的解决方案，直接Google，第一个stackoverflow的链接是Xcode 14 needs selected Development Team for Pod Bundles，这里面给出的解决方法是，在Podfile里增加下面代码，然后运行Pod install，设置Pod库的DEVELOPMENT_TEAM是开发者账号的team。 笔者有两个项目，其中一个是Swift为主，用下面的设置方法试了，可以解决。要注意的是如果项目有多个target，ta...</div></div></div></a><a class="pagination-related" href="/2022/10/11/Xcode%2014%E7%BC%96%E8%AF%91%E7%9A%84APP%E4%BD%8E%E7%89%88%E6%9C%AC%E5%B4%A9%E6%BA%83/" title="Xcode14编译的APP低版本崩溃"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-11</div><div class="info-item-2">Xcode14编译的APP低版本崩溃</div></div><div class="info-2"><div class="info-item-1">背景测试说iOS 12的手机上安装Xcode14.0.2导出的新包后，打开就崩溃，但是在系统版本高的手机上就没有问题。   调试后发现，崩溃日志是dyld: Library not loaded: /usr/lib/swift/libswiftCoreGraphics.dylib，具体如下：  dyld: Library not loaded: /usr/lib/swift/libswiftCoreGraphics.dylib  Referenced from: /private/var/containers/Bundle/Application/55730273-D9D6-4C42-9335-7A56F92B7F2C/xxx.app/Frameworks/FSPagerView.framework/FSPagerView  Reason: image not founds  搜索后发现，开发者社区中有此问题的记录，xcode14:Library not loaded: /usr/lib/swift/libswiftCoreGraphics.dylib，解决方案是：  If yo...</div></div></div></a><a class="pagination-related" href="/2021/06/30/iOS%20StatusBar%E8%AE%BE%E7%BD%AE/" title="iOS StatusBar 设置"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-30</div><div class="info-item-2">iOS StatusBar 设置</div></div><div class="info-2"><div class="info-item-1">iOS StatusBar 设置背景最近遇到设置StatusBar的问题，在NavigationController出来的界面设置StatusBar后一直不生效，印象中遇到过此类的问题，但是没有记录总结，还是花费了一点时间来找到原因，所以赶紧记录一下。   全局设置StatusBar的全局设置，需要首先在info.plist中设置View controller-based status bar appearance为NO，关掉按界面设置status bar 显示。 显示/隐藏方法一：在Target下的Deployment Info中不勾选/勾选Hide status bar  方法二：代码设置 1[UIApplication sharedApplication].statusBarHidden = YES;   设置方法一：在Target下的Deployment Info中设置Status Bar Style  方法二：代码设置 1[UIApplication sharedApplication].statusBarStyle = UIStatusBarStyleLightCon...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/assets/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">今是昨非</div><div class="author-info-description">技术分享、生活感悟</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">190</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mokong"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/mokong" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://x.com/morgan2015_wang" target="_blank" title="Twitter"><i class="fab fa-X"></i></a><a class="social-icon" href="mailto:mokong.2015.1992@email.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#APP%E6%94%AF%E6%8C%81%E7%94%BB%E4%B8%AD%E7%94%BB%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.</span> <span class="toc-text">APP支持画中画功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E6%92%AD%E6%94%BE%E5%99%A8%E6%97%B6%E7%94%BB%E4%B8%AD%E7%94%BB%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">使用系统播放器时画中画的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%92%AD%E6%94%BE%E5%99%A8%E6%97%B6%E7%94%BB%E4%B8%AD%E7%94%BB%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.3.</span> <span class="toc-text">自定义播放器时画中画的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E5%88%86%E7%A7%92%E8%AE%A1%E6%97%B6%E7%94%BB%E4%B8%AD%E7%94%BB%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.</span> <span class="toc-text">时分秒计时画中画的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%8A%E6%AF%8F%E6%97%A5%E8%8B%B1%E8%AF%AD%E5%90%AC%E5%8A%9B%E3%80%8B%E7%94%BB%E4%B8%AD%E7%94%BB%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.</span> <span class="toc-text">《每日英语听力》画中画的实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/27/CodeBuddyCN%20%E4%BD%BF%E7%94%A8%E5%85%8D%E8%B4%B9%E7%9A%84%E4%B8%83%E7%89%9B%20Model%20%E6%AD%A5%E9%AA%A4/" title="CodeBuddyCN 使用免费的七牛 Model 步骤">CodeBuddyCN 使用免费的七牛 Model 步骤</a><time datetime="2026-01-27T11:49:00.000Z" title="发表于 2026-01-27 19:49:00">2026-01-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/22/Google%20Antigravity%20%E7%99%BB%E5%BD%95%E4%B8%8D%E4%BA%86%E8%A7%A3%E5%86%B3/" title="Google Antigravity 登录不了解决">Google Antigravity 登录不了解决</a><time datetime="2026-01-22T02:38:00.000Z" title="发表于 2026-01-22 10:38:00">2026-01-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/21/%E8%BF%9E%E5%A4%9C%E5%BC%80%E5%8F%91%E4%BA%86%E4%B8%80%E4%B8%AA%20Mac%20%E4%B8%8A%E4%B9%85%E5%9D%90%E6%8F%90%E9%86%92%E5%B7%A5%E5%85%B7/" title="连夜开发了一个 Mac 上久坐提醒工具">连夜开发了一个 Mac 上久坐提醒工具</a><time datetime="2026-01-21T13:45:00.000Z" title="发表于 2026-01-21 21:45:00">2026-01-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/20/%E5%85%B3%E4%BA%8E%20AI%20%E4%B8%8E%E5%BC%80%E5%8F%91/" title="关于 AI 与开发">关于 AI 与开发</a><time datetime="2026-01-20T11:41:00.000Z" title="发表于 2026-01-20 19:41:00">2026-01-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/16/%E5%88%B6%E4%BD%9C%E8%87%AA%E5%B7%B1%E8%A1%A8%E6%83%85%E5%8C%85/" title="制作自己表情包">制作自己表情包</a><time datetime="2026-01-16T02:21:00.000Z" title="发表于 2026-01-16 10:21:00">2026-01-16</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2026 By 今是昨非</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 5.4.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3</a></span></div><div class="footer_custom_text"><span>日出江花红胜火，春来江水绿如蓝，能不忆江南</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      false
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>